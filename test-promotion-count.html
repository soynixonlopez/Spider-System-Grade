<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Promotion Count - Spider System</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🧪 Test Promotion Count</h1>
    
    <div class="test-section info">
        <h3>📋 Instrucciones de Prueba</h3>
        <p>Esta página te permite verificar el conteo de estudiantes en promociones.</p>
        <p><strong>Nota:</strong> Asegúrate de estar logueado como admin antes de usar esta página.</p>
    </div>
    
    <div class="test-section">
        <h3>🔧 Verificar Datos</h3>
        <button onclick="checkPromotions()">📊 Ver Promociones</button>
        <button onclick="checkStudents()">👥 Ver Estudiantes</button>
        <button onclick="checkCounts()">🔢 Ver Conteos</button>
        <button onclick="clearResults()">🗑️ Limpiar</button>
    </div>
    
    <div id="testResults" class="test-section">
        <h3>📊 Resultados de la Prueba</h3>
        <div id="resultsContent">
            <p>Los resultados aparecerán aquí...</p>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module" src="js/firebase-config.js"></script>
    <script type="module">
        import { auth, db } from './js/firebase-config.js';
        import { getDocs, collection, query, where } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        
        let promotions = [];
        let students = [];
        
        // Test functions
        window.checkPromotions = async function() {
            const resultsDiv = document.getElementById('resultsContent');
            resultsDiv.innerHTML = '<p>🔄 Verificando promociones...</p>';
            
            try {
                const snapshot = await getDocs(collection(db, 'promotions'));
                promotions = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data() 
                }));
                
                resultsDiv.innerHTML = `
                    <h4>📊 Promociones (${promotions.length})</h4>
                    <pre>${JSON.stringify(promotions, null, 2)}</pre>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">❌ Error: ${error.message}</p>`;
            }
        };
        
        window.checkStudents = async function() {
            const resultsDiv = document.getElementById('resultsContent');
            resultsDiv.innerHTML = '<p>🔄 Verificando estudiantes...</p>';
            
            try {
                const studentsQuery = query(
                    collection(db, 'users'),
                    where('role', '==', 'student')
                );
                const snapshot = await getDocs(studentsQuery);
                students = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data() 
                }));
                
                resultsDiv.innerHTML = `
                    <h4>👥 Estudiantes (${students.length})</h4>
                    <pre>${JSON.stringify(students, null, 2)}</pre>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">❌ Error: ${error.message}</p>`;
            }
        };
        
        window.checkCounts = async function() {
            const resultsDiv = document.getElementById('resultsContent');
            resultsDiv.innerHTML = '<p>🔄 Calculando conteos...</p>';
            
            if (promotions.length === 0 || students.length === 0) {
                resultsDiv.innerHTML = '<p class="error">❌ Primero carga las promociones y estudiantes</p>';
                return;
            }
            
            const counts = promotions.map(promotion => {
                const studentCount = students.filter(s => s.promotionId === promotion.id).length;
                const studentNames = students.filter(s => s.promotionId === promotion.id)
                    .map(s => `${s.firstName} ${s.lastName}`)
                    .join(', ');
                
                return {
                    promotion: `${promotion.name} - ${promotion.turn}`,
                    promotionId: promotion.id,
                    studentCount: studentCount,
                    students: studentNames || 'Ninguno'
                };
            });
            
            resultsDiv.innerHTML = `
                <h4>🔢 Conteos por Promoción</h4>
                <pre>${JSON.stringify(counts, null, 2)}</pre>
                
                <h4>📊 Resumen</h4>
                <ul>
                    ${counts.map(c => `<li><strong>${c.promotion}:</strong> ${c.studentCount} estudiantes</li>`).join('')}
                </ul>
            `;
        };
        
        window.clearResults = function() {
            document.getElementById('resultsContent').innerHTML = '<p>Los resultados aparecerán aquí...</p>';
        };
    </script>
</body>
</html>
